# iCloud CloudKit Sync - Setup Guide

## Overview

Deets now supports optional iCloud CloudKit sync to keep business cards synchronized across all user devices. The implementation uses SwiftData's built-in CloudKit integration for seamless, automatic synchronization.

## Features

- **Optional Sync**: Users can enable/disable iCloud sync at any time
- **Automatic Sync**: Changes sync automatically in the background
- **Conflict Resolution**: Last-write-wins strategy for conflict resolution
- **Network Resilience**: Handles offline scenarios gracefully
- **Privacy First**: Data stays in user's private iCloud database
- **Status Monitoring**: Real-time sync status and error reporting

## Architecture

### Core Components

1. **CloudKitConfiguration** (`Config/CloudKitConfiguration.swift`)
   - Singleton managing sync preferences
   - CloudKit container configuration
   - iCloud availability checking
   - Sync status coordination

2. **SyncService** (`Services/SyncService.swift`)
   - Orchestrates sync operations
   - Network monitoring
   - Automatic background sync
   - Manual sync triggers
   - Error handling and recovery

3. **SyncViewModel** (`ViewModels/SyncViewModel.swift`)
   - UI state management
   - User interaction handling
   - Status display formatting
   - Error alerts

4. **SyncStatusView** (`Views/SyncStatusView.swift`)
   - Settings UI for sync management
   - Status display
   - Manual sync controls
   - Troubleshooting tools

### Data Flow

```
User Action (Enable Sync)
    ↓
SyncViewModel.toggleSync()
    ↓
CloudKitConfiguration.enableSync()
    ↓
DeetsApp recreates ModelContainer with .private CloudKit database
    ↓
SyncService begins automatic sync
    ↓
SwiftData + CloudKit handle data synchronization
    ↓
Status updates flow back to UI
```

## Xcode Setup

### 1. Add Entitlements File

The entitlements file `Deets.entitlements` has been created with:
- CloudKit capability
- iCloud container identifier: `iCloud.com.sharedeets.businesscards`

**Xcode Configuration:**
1. Open project in Xcode
2. Select the Deets target
3. Go to "Signing & Capabilities" tab
4. Click "+ Capability" and add:
   - **iCloud**
     - Enable: CloudKit
     - Containers: `iCloud.com.sharedeets.businesscards`

### 2. Update Bundle Identifier

Ensure your bundle identifier matches the CloudKit container:
- If your bundle ID is different, update `CloudKitConfiguration.containerIdentifier`
- Container ID format: `iCloud.{your.bundle.identifier}`

### 3. Apple Developer Account Setup

1. Sign in to [Apple Developer](https://developer.apple.com)
2. Go to "Certificates, Identifiers & Profiles"
3. Select your App ID
4. Enable "iCloud" capability
5. Configure CloudKit container (will be auto-created on first use)

### 4. CloudKit Dashboard (Optional)

View sync data in [CloudKit Dashboard](https://icloud.developer.apple.com):
- Select your container: `iCloud.com.sharedeets.businesscards`
- View schema (auto-generated by SwiftData)
- Monitor sync records
- Test queries

## Usage

### For Users

1. **Enable Sync**:
   - Open Cards list
   - Tap iCloud icon in top-left
   - Toggle "iCloud Sync" on
   - Grant permission when prompted

2. **Monitor Status**:
   - Icon color indicates status:
     - Gray: Sync disabled
     - Green: Up to date
     - Blue: Syncing
     - Red: Error
   - Tap icon to see details

3. **Manual Sync**:
   - Open sync settings
   - Tap "Sync Now"
   - View pending changes count

4. **Troubleshooting**:
   - "Force Full Sync" resets sync state
   - Check iCloud account in Settings
   - Ensure network connectivity

### For Developers

#### Enable Sync Programmatically

```swift
// Access sync service through environment
@EnvironmentObject var syncViewModel: SyncViewModel

// Enable sync
Task {
    await syncViewModel.syncService?.enableSync()
}
```

#### Monitor Sync Status

```swift
// Observe status changes
syncViewModel.$syncStatus
    .sink { status in
        switch status {
        case .idle:
            print("Sync complete")
        case .syncing:
            print("Sync in progress")
        case .error(let error):
            print("Sync error: \(error)")
        case .notConfigured:
            print("Sync disabled")
        }
    }
```

#### Manual Sync Trigger

```swift
// Trigger manual sync
await syncViewModel.syncService?.sync()

// Force full sync (for troubleshooting)
await syncViewModel.syncService?.forceFullSync()
```

## Data Model Changes

### BusinessCard Enhancements

Added CloudKit metadata fields:
- `cloudKitModificationDate: Date?` - Last server update timestamp
- `isLocalOnly: Bool` - Tracks if record was created locally

These fields help with:
- Conflict detection
- Sync debugging
- Offline change tracking

### SwiftData Schema Migration

SwiftData handles schema migration automatically. When users enable sync:
1. Local data is preserved
2. Schema is uploaded to CloudKit
3. Existing records sync to cloud
4. New devices download schema and data

## Conflict Resolution

**Strategy**: Last-Writer-Wins (LWW)

- Most recent modification timestamp wins
- Relies on `dateModified` field in BusinessCard
- SwiftData + CloudKit handle resolution automatically
- No user intervention required for conflicts

**Alternative Strategies** (future consideration):
- Keep Both: Create duplicate on conflict
- Manual: Prompt user to choose version

## Network Handling

### Offline Behavior

- Changes saved locally immediately
- Sync queued until network available
- Automatic retry when online
- Status shows "Network unavailable" error

### Sync Timing

**Automatic Sync Triggers**:
- Every 5 minutes (when app active)
- App becomes active (foreground)
- App enters background
- After local changes
- Network reconnection

**Manual Sync**:
- User taps "Sync Now"
- Force full sync for troubleshooting

## Error Handling

### Common Errors

1. **iCloud Unavailable**
   - User not signed into iCloud
   - Solution: Prompt to open Settings

2. **Network Unavailable**
   - No internet connection
   - Solution: Auto-retry when online

3. **Quota Exceeded**
   - iCloud storage full
   - Solution: User must free space

4. **Authentication Failed**
   - iCloud account issue
   - Solution: Re-sign into iCloud

### Error Recovery

- All errors shown to user with clear messages
- Network errors auto-retry
- Authentication errors prompt settings
- Unknown errors logged for debugging

## Privacy & Security

### Data Privacy

- **Private Database**: Data only accessible by signed-in user
- **End-to-End Encryption**: Data encrypted in transit and at rest
- **No Sharing**: Business cards not shared with other users
- **User Control**: Sync can be disabled anytime

### Compliance

- Follows Apple's [App Store Review Guidelines](https://developer.apple.com/app-store/review/guidelines/)
- GDPR compliant (user controls data)
- No third-party data access
- Clear privacy policy in app

## Testing

### Local Testing

1. **Simulator**:
   - Sign into iCloud in Settings app
   - Enable sync in Deets
   - Add test business cards
   - Verify sync status updates

2. **Multiple Simulators**:
   - Use same iCloud account
   - Enable sync on both
   - Add card on device A
   - Verify appears on device B

### Device Testing

1. **Physical Device**:
   - Use development provisioning profile
   - Sign into iCloud (Settings)
   - Enable sync in app
   - Monitor CloudKit Dashboard

2. **Multi-Device Sync**:
   - iPhone + iPad with same account
   - Add card on iPhone
   - Wait 5-10 seconds
   - Pull to refresh or wait for auto-sync
   - Verify on iPad

### CloudKit Dashboard Testing

1. Open [CloudKit Dashboard](https://icloud.developer.apple.com)
2. Select container: `iCloud.com.sharedeets.businesscards`
3. Go to "Data" tab
4. View `CD_BusinessCard` records
5. Verify data structure and content

## Performance Considerations

### Optimization Strategies

1. **Lazy Sync**: Only sync when needed
2. **Delta Sync**: Only upload changes (handled by CloudKit)
3. **Background Sync**: Non-blocking UI operations
4. **Network-Aware**: Pause on poor connection
5. **Batch Operations**: Group multiple changes

### Storage Limits

- **CloudKit Free Tier**:
  - 1 PB public database
  - Unlimited private database
  - 10 MB per record
- **Business Cards**: ~10-50 KB each
- **Practical Limit**: Thousands of cards easily

## Troubleshooting

### Sync Not Working

1. **Check iCloud Sign-In**:
   - Settings > [Name] > iCloud
   - Verify signed in

2. **Check Network**:
   - Verify internet connection
   - Try "Force Full Sync"

3. **Check CloudKit Status**:
   - [Apple System Status](https://www.apple.com/support/systemstatus/)
   - Verify CloudKit is operational

4. **Reset Sync**:
   - Disable sync
   - Wait 30 seconds
   - Enable sync again
   - Try "Force Full Sync"

### Development Issues

1. **Container Not Found**:
   - Verify entitlements match bundle ID
   - Check Apple Developer portal
   - Recreate provisioning profile

2. **Schema Mismatch**:
   - Delete app and reinstall
   - CloudKit Dashboard > Reset Development
   - Rebuild and test

3. **Authentication Errors**:
   - Sign out and back into iCloud
   - Check provisioning profile
   - Verify capabilities in Xcode

## Future Enhancements

### Potential Improvements

1. **Conflict UI**: Show conflicts to user for manual resolution
2. **Selective Sync**: Choose which cards to sync
3. **Sync History**: View sync activity log
4. **Bandwidth Control**: Limit sync on cellular
5. **Public Sharing**: Share cards via CloudKit public database
6. **Collaboration**: Share cards with other users
7. **Web Portal**: Access cards via iCloud.com

### SwiftData + CloudKit Evolution

- Monitor SwiftData updates in new iOS versions
- Adopt new CloudKit features (push notifications, etc.)
- Consider CKSyncEngine for advanced control

## Resources

### Apple Documentation

- [SwiftData Documentation](https://developer.apple.com/documentation/swiftdata)
- [CloudKit Documentation](https://developer.apple.com/documentation/cloudkit)
- [iCloud Design Guide](https://developer.apple.com/design/human-interface-guidelines/icloud)

### WWDC Sessions

- [What's new in SwiftData (WWDC 2024)](https://developer.apple.com/videos/play/wwdc2024/10137/)
- [CloudKit Best Practices](https://developer.apple.com/videos/play/wwdc2021/10086/)

### Tools

- [CloudKit Dashboard](https://icloud.developer.apple.com)
- [Apple System Status](https://www.apple.com/support/systemstatus/)
- [Xcode CloudKit Console](https://developer.apple.com/documentation/cloudkit/viewing_cloudkit_data_in_xcode)

## Support

For issues or questions:
1. Check this documentation
2. Review Apple's CloudKit documentation
3. Test in CloudKit Dashboard
4. Check Apple Developer Forums

---

**Last Updated**: 2025-11-05
**Version**: 1.0.0
**Author**: ATLAS Mobile Development AI
