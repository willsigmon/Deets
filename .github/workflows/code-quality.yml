name: Code Quality

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'

  workflow_dispatch:

env:
  DEVELOPER_DIR: /Applications/Xcode_15.2.app/Contents/Developer

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # SWIFTLINT
  # ============================================================================
  swiftlint:
    name: SwiftLint Analysis
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache SwiftLint
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/swiftlint
          key: ${{ runner.os }}-swiftlint-0.55.0

      - name: Install SwiftLint
        run: |
          if ! command -v swiftlint &> /dev/null; then
            brew install swiftlint
          fi
          swiftlint version

      - name: Run SwiftLint (strict mode)
        run: swiftlint lint --strict --reporter github-actions-logging

      - name: Generate SwiftLint report
        if: always()
        run: |
          swiftlint lint --reporter html > swiftlint-report.html || true
          swiftlint lint --reporter json > swiftlint-report.json || true

      - name: Upload SwiftLint reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: swiftlint-reports
          path: |
            swiftlint-report.html
            swiftlint-report.json
          retention-days: 90

  # ============================================================================
  # CODE METRICS
  # ============================================================================
  code-metrics:
    name: Code Metrics
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Count lines of code
        run: |
          echo "## Code Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Swift files
          SWIFT_FILES=$(find Deets -name "*.swift" | wc -l | xargs)
          SWIFT_LINES=$(find Deets -name "*.swift" -exec cat {} \; | wc -l | xargs)

          echo "### Swift Code" >> $GITHUB_STEP_SUMMARY
          echo "- Files: $SWIFT_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- Lines: $SWIFT_LINES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test files
          TEST_FILES=$(find DeetsTests -name "*.swift" 2>/dev/null | wc -l | xargs)
          TEST_LINES=$(find DeetsTests -name "*.swift" -exec cat {} \; 2>/dev/null | wc -l | xargs)

          echo "### Test Code" >> $GITHUB_STEP_SUMMARY
          echo "- Files: $TEST_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- Lines: $TEST_LINES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Coverage ratio
          if [ $SWIFT_LINES -gt 0 ]; then
            RATIO=$(awk "BEGIN {printf \"%.1f\", ($TEST_LINES / $SWIFT_LINES) * 100}")
            echo "### Test Coverage Ratio" >> $GITHUB_STEP_SUMMARY
            echo "- Test/Source: ${RATIO}%" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Analyze code complexity
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Code Complexity" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find large files
          echo "#### Large Files (>300 lines)" >> $GITHUB_STEP_SUMMARY
          find Deets -name "*.swift" -exec wc -l {} \; | \
            awk '$1 > 300 {print $2": "$1" lines"}' | \
            sort -t':' -k2 -nr | \
            head -10 | \
            awk '{print "- "$0}' >> $GITHUB_STEP_SUMMARY || echo "- None found" >> $GITHUB_STEP_SUMMARY

      - name: Check TODO/FIXME comments
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Technical Debt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TODO_COUNT=$(grep -r "// TODO" Deets --include="*.swift" | wc -l | xargs)
          FIXME_COUNT=$(grep -r "// FIXME" Deets --include="*.swift" | wc -l | xargs)
          HACK_COUNT=$(grep -r "// HACK" Deets --include="*.swift" | wc -l | xargs)

          echo "- TODO comments: $TODO_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- FIXME comments: $FIXME_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- HACK comments: $HACK_COUNT" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # SECURITY SCAN
  # ============================================================================
  security-scan:
    name: Security Analysis
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

      - name: Scan for hardcoded credentials
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for potential secrets
          SUSPICIOUS_PATTERNS=(
            "password"
            "api_key"
            "apiKey"
            "secret"
            "token"
            "credential"
          )

          for pattern in "${SUSPICIOUS_PATTERNS[@]}"; do
            COUNT=$(grep -ri "$pattern" Deets --include="*.swift" | \
                    grep -v "// " | \
                    grep -v "NSString" | \
                    wc -l | xargs)
            if [ $COUNT -gt 0 ]; then
              echo "⚠️  Found $COUNT instances of '$pattern'" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Check for force unwrapping
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Swift Safety Issues" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FORCE_UNWRAP=$(grep -r "!" Deets --include="*.swift" | \
                        grep -v "!=" | \
                        grep -v "// " | \
                        wc -l | xargs)
          FORCE_TRY=$(grep -r "try!" Deets --include="*.swift" | wc -l | xargs)
          FORCE_CAST=$(grep -r "as!" Deets --include="*.swift" | wc -l | xargs)

          echo "- Force unwraps (!): $FORCE_UNWRAP" >> $GITHUB_STEP_SUMMARY
          echo "- Force try (try!): $FORCE_TRY" >> $GITHUB_STEP_SUMMARY
          echo "- Force casts (as!): $FORCE_CAST" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # DEPENDENCY AUDIT
  # ============================================================================
  dependency-audit:
    name: Dependency Audit
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Analyze SPM dependencies
        run: |
          echo "## Dependency Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "Package.swift" ]; then
            # Extract dependencies from Package.swift
            echo "### Swift Package Manager" >> $GITHUB_STEP_SUMMARY
            grep -A 5 "dependencies:" Package.swift | \
              grep ".package" | \
              sed 's/^[[:space:]]*/- /' >> $GITHUB_STEP_SUMMARY || \
              echo "- No external dependencies (privacy-first approach ✅)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for outdated practices
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Code Modernization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for old-style closures
          OLD_CLOSURES=$(grep -r "-> Void in" Deets --include="*.swift" | wc -l | xargs)
          echo "- Old-style closure syntax: $OLD_CLOSURES" >> $GITHUB_STEP_SUMMARY

          # Check for NSObject usage
          NSOBJECT=$(grep -r ": NSObject" Deets --include="*.swift" | wc -l | xargs)
          echo "- NSObject subclasses: $NSOBJECT" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # DOCUMENTATION COVERAGE
  # ============================================================================
  documentation-coverage:
    name: Documentation Coverage
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check documentation coverage
        run: |
          echo "## Documentation Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count documented vs undocumented types
          TOTAL_TYPES=$(grep -rh "^(public |internal |private )?(class|struct|enum|protocol|extension)" Deets --include="*.swift" | wc -l | xargs)
          DOCUMENTED_TYPES=$(grep -rB1 "^(public |internal |private )?(class|struct|enum|protocol|extension)" Deets --include="*.swift" | grep "///" | wc -l | xargs)

          if [ $TOTAL_TYPES -gt 0 ]; then
            DOC_PERCENTAGE=$(awk "BEGIN {printf \"%.1f\", ($DOCUMENTED_TYPES / $TOTAL_TYPES) * 100}")
            echo "- Total types: $TOTAL_TYPES" >> $GITHUB_STEP_SUMMARY
            echo "- Documented types: $DOCUMENTED_TYPES" >> $GITHUB_STEP_SUMMARY
            echo "- Coverage: ${DOC_PERCENTAGE}%" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check README quality
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Documentation Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for essential documentation
          DOCS=(
            "README.md"
            "CHANGELOG.md"
            "CONTRIBUTING.md"
            "LICENSE"
            "BUILD_GUIDE.md"
          )

          for doc in "${DOCS[@]}"; do
            if [ -f "$doc" ]; then
              SIZE=$(wc -l < "$doc" | xargs)
              echo "- ✅ $doc ($SIZE lines)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ $doc (missing)" >> $GITHUB_STEP_SUMMARY
            fi
          done

  # ============================================================================
  # SUMMARY REPORT
  # ============================================================================
  quality-report:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [swiftlint, code-metrics, security-scan, dependency-audit, documentation-coverage]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- SwiftLint: ${{ needs.swiftlint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Metrics: ${{ needs.code-metrics.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Audit: ${{ needs.dependency-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation Coverage: ${{ needs.documentation-coverage.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [[ "${{ needs.swiftlint.result }}" == "success" && \
                "${{ needs.security-scan.result }}" == "success" ]]; then
            echo "### ✅ Overall Status: PASS" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ❌ Overall Status: NEEDS ATTENTION" >> $GITHUB_STEP_SUMMARY
          fi
